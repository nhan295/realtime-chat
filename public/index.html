<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Realtime chat</title>
    <link rel="stylesheet" href="./style/index.css">
</head>
<body>

    <div class="chat-container">
        <div class="chat-header">
            <h1>
                üí¨ Realtime Chat
                 <span class="status-indicator"></span>
            </h1>
        </div>

        <ul id="message">
            <div class="empty-state">
                Start chatting now!
            </div>
        </ul>

        <div id="typing"></div>
        <form action="" id="form">
            <input type="text" name="" id="input" autocomplete="off" placeholder="Type your message here..." />
            <button>Send</button>
        </form>
    </div>
</body>

<script src="/socket.io/socket.io.js"></script>
<script>
    let mySocketId = '';
    const socket = io();   // k·∫øt n·ªëi ƒë·∫øn server socket.io
    const form = document.getElementById('form')  //l·∫•y to√†n b·ªô ph·∫ßn t·ª≠ HTML c√≥ id="form"
    const input = document.getElementById('input') // l·∫•y to√†n b·ªô ph·∫ßn t·ª≠ HTML c√≥ id="input"
    const message = document.getElementById('message');
    let typing = false

     socket.on('connect',()=>{
        mySocketId = socket.id // l∆∞u ID c·ªßa socket khi k·∫øt n·ªëi th√†nh c√¥ng
    })

    form.addEventListener('submit', function(e){
        e.preventDefault(); // ngƒÉn load l·∫°i form
        if(input.value){
            socket.emit('chat message', input.value);
            input.value = ''
        }
    });

    input.addEventListener('input',()=>{
        if(!typing) {
            typing = true; // ƒë√°nh d·∫•u l√† ƒëang g√µ
            socket.emit('typing',true); // g·ª≠i s·ª± ki·ªán 'typing' khi ng∆∞·ªùi d√πng b·∫Øt ƒë·∫ßu g√µ
        }
        clearTimeout(input.typingTimeout); // x√≥a timeout tr∆∞·ªõc ƒë√≥ n·∫øu c√≥
        input.typingTimeout = setTimeout(()=>{
            typing = false;
            socket.emit('typing',false);
        },1000); // ƒë·∫∑t timeout ƒë·ªÉ g·ª≠i s·ª± ki·ªán 'typing' sau 500ms n·∫øu kh√¥ng c√≥ ho·∫°t ƒë·ªông g√µ ti·∫øp theo
       
    })
    
    socket.on('typing',(username)=>{
       
            const typing = document.getElementById('typing');
            if(!typing.querySelector('.typing-indicator')){
                const indicator = document.createElement('div')
                indicator.className = 'typing-indicator';

                const nameSpan = document.createElement('span');
                nameSpan.textContent =  `${username} is typing...`
                
                const dot1 = document.createElement('div');
                const dot2 = document.createElement('div');
                const dot3 = document.createElement('div');

                dot1.className  = dot2.className = dot3.className = 'typing-dot';

                indicator.appendChild(nameSpan);
                indicator.appendChild(dot1);
                indicator.appendChild(dot2);
                indicator.appendChild(dot3);

                typing.appendChild(indicator); // th√™m ph·∫ßn t·ª≠ indicator v√†o ph·∫ßn t·ª≠ typing
            }
            
        
    })

    socket.on('stop-typing',(username)=>{
        const typing = document.getElementById('typing');
        const indicator = typing.querySelector('.typing-indicator');
        if(indicator){
            indicator.remove(); // x√≥a ph·∫ßn t·ª≠ indicator khi ng∆∞·ªùi d√πng kh√¥ng c√≤n g√µ n·ªØa
        }
    })


    socket.on('chat message',function(msg){

        function removeEmptyState() {
            const emptyState = message.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }
        }
        removeEmptyState(); // x√≥a tr·∫°ng th√°i r·ªóng n·∫øu c√≥

        function formatTime() {
            const now = new Date();
            return now.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
        }
        msg.time = formatTime(); // ƒë·ªãnh d·∫°ng th·ªùi gian g·ª≠i tin nh·∫Øn
       
        const item = document.createElement('li') // t·∫°o ph·∫ßn t·ª≠ li

        const isMine = msg.senderId === mySocketId; // ki·ªÉm tra xem tin nh·∫Øn c√≥ ph·∫£i c·ªßa ng∆∞·ªùi d√πng hi·ªán t·∫°i kh√¥ng
        item.classList.add(isMine ? 'message-right' : 'message-left');

        const bubble = document.createElement('div');
        bubble.className = 'bubble';
        
        const messageHeader = document.createElement('div');
        messageHeader.className = 'message-header';

        const username = document.createElement('span');
        username.className = 'username';
        username.textContent = msg.user; // hi·ªÉn th·ªã t√™n ng∆∞·ªùi d√πng

        const timestamp = document.createElement('span');
        timestamp.className = 'timestamp'
        timestamp.textContent = msg.time; // hi·ªÉn th·ªã th·ªùi gian g·ª≠i tin nh·∫Øn

        messageHeader.appendChild(username);
        messageHeader.appendChild(timestamp);

        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        messageContent.textContent = msg.text;


        bubble.appendChild(messageHeader);
        bubble.appendChild(messageContent)

        item.appendChild(bubble);
        message.appendChild(item);
        message.scrollTop = message.scrollHeight; // cu·ªôn xu·ªëng cu·ªëi c√πng

    })
</script>
</html>